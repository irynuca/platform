<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Analiza Fundamentală</title>
    <!-- Bootstrap 5.3 CSS from CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Your Custom Styles -->

    <!-- Line Awesome Icons -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/line-awesome.min.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">


    
    <!-- Theme & Vendor CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='icons/font-awesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/animate/animate.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/perfect-scrollbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/jquery-nice-select/css/nice-select.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/jquery-autocomplete/jquery-ui.css') }}">

    <!-- jQuery First -->
    <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>

    <!-- Plugins (jQuery must be above these) -->
    <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/perfect-scrollbar/js/perfect-scrollbar.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/metismenu/js/metisMenu.min.js') }}"></script>

    <!-- Dolab Settings -->
    <script src="{{ url_for('static', filename='js/dlab-settings.js') }}"></script>
    
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Flot Chart JS -->
    <script src="{{ url_for('static', filename='vendor/flot/jquery.flot.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/flot/jquery.flot.resize.js') }}"></script>

    <script src="{{ url_for('static', filename='js/plugins-init/flot-init.js') }}"></script>
    <!-- Chart.js v4 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- DataLabels plugin for Chart.js v4 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>




</head>

<body>

<!-- Preloader -->
<div id="preloader">
    <div class="inner">
        <span>Loading </span>
        <div class="loading"></div>
    </div>
</div>

 <!-- Sidebar Navigation -->
 <div class="dlabnav">
    <div class="dlabnav-scroll mm-active ps">
        <ul class="metismenu mm-show" id="menu">

            <li><a href="{{ url_for('main.home') }}" class="has-arrow " href="javascript:void()" aria-expanded="false">
                <div class="menu-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g id="IconlyHome"><g id="Home">
                        <path id="Home_2" d="M9.13478 20.7733V17.7156C9.13478 16.9351 9.77217 16.3023 10.5584 16.3023H13.4326C13.8102 16.3023 14.1723 16.4512 14.4393 16.7163C14.7063 16.9813 14.8563 17.3408 14.8563 17.7156V20.7733C14.8539 21.0978 14.9821 21.4099 15.2124 21.6402C15.4427 21.8705 15.7561 22 16.0829 22H18.0438C18.9596 22.0023 19.8388 21.6428 20.4872 21.0008C21.1356 20.3588 21.5 19.487 21.5 18.5778V9.86686C21.5 9.13246 21.1721 8.43584 20.6046 7.96467L13.934 2.67587C12.7737 1.74856 11.1111 1.7785 9.98539 2.74698L3.46701 7.96467C2.87274 8.42195 2.51755 9.12064 2.5 9.86686V18.5689C2.5 20.4639 4.04738 22 5.95617 22H7.87229C8.55123 22 9.103 21.4562 9.10792 20.7822L9.13478 20.7733Z" fill="#130F26"/>
                        </g></g>
                    </svg>
                </div>	
                    <span class="nav-text">Acasa</span>
                </a>
            </li>

            <li><a href="app-calender.html" class="" href="javascript:void()" aria-expanded="false">
                <div class="menu-icon">
                    <img src="{{ url_for('static', filename='icons/calendar-alt.svg') }}" width="24" height="24" alt="Calendar Icon" fill="#B9A8FF">
                </div>	
                    
                    <span class="nav-text ms-2">Calendar</span>
                </a>
            </li>
        </ul>
    </div>
</div>
    
<!-- Main Wrapper (Includes Sidebar + Animation) -->
<div id="main-wrapper" class="d-flex">
    <div class="container-fluid px-4">
        <!-- Header Section with Three Columns -->
        <div class="row text-center align-items-center">
            
            <!-- Left: Company Name -->
            <div class="col-md-4 text-start">
                <div class="row">
                    <div class="col-12">
                        <h2 class="fw-bold"> {{ company_name }}</h1>
                    </div>
                    <div class="col-12">
                        <h4 class="fw-bold text-muted"> Industrie: {{ industry }}</h4>
                    </div>
                </div>
            </div>

            <!-- Middle: Stock Price & Variation -->
            <div class="col-md-4 text-center">
                <h3 class="fw-bold">{{ last_price | round(2)}} RON</h3>
                <p class="{% if price_variation|float >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ price_variation }}%
                </p>
            </div>

            <!-- Right Column: Portfolio & Wishlist Buttons -->
            <div class="col-md-4 text-end">
                <div class="row">
                    <div class="col-12 mb-2">
                        <button class="btn btn-primary btn-sm">Portofoliu</button>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-secondary btn-sm">Watchlist</button>
                    </div>
                </div>
            </div>
        </div>

<!-- Key Financial Metrics Section -->
<div class="container">
    <div class="row text-center mt-3">

        <!-- Column 1: Market Cap -->
        <div class="col-md-2">
            <div class="row">
                <div class="col-12">
                    <p class="fw-bold text-purple">{{ (market_cap / 1_000_000) | round(1) | string | replace('.', ',') }} mnRON
                    </p>
                </div>
                <div class="col-12">
                    <p class="text-muted small">Capitalizare bursieră</p>
                </div>
            </div>
        </div>

        <!-- Column 2: YoY Change / YTD Change -->
        <div class="col-md-2">
            <div class="row">
                <div class="col-12">
                    <p class="fw-bold text-purple">{{ yoy_change }} % / {{ ytd_change }} %</p>
                </div>
                <div class="col-12">
                    <p class="text-muted small">var. an/an / din ian.</p>
                </div>
            </div>
        </div>

        <!-- Column 3: P/E Ratio -->
        <div class="col-md-2">
            <div class="row">
                <div class="col-12">
                    <p class="fw-bold text-purple">{{ pe_ratio | round(2) }}x</p>
                </div>
                <div class="col-12">
                    <p class="text-muted small">P/E</p>
                </div>
            </div>
        </div>

        <!-- Column 4: Net Income -->
        <div class="col-md-2">
            <div class="row">
                <div class="col-12">
                    <p class="fw-bold text-purple">{{ (net_income / 1e6) | round(1) | string | replace('.', ',') }} mnRON
                    </p>
                </div>
                <div class="col-12">
                    <p class="text-muted small">Profit net LTM</p>
                </div>
            </div>
        </div>

        <!-- Column 5: Next Earnings Date -->
        <div class="col-md-2">
            <div class="row">
                <div class="col-12">
                    <p class="fw-bold text-purple">{{ next_earnings_date }}</p>
                </div>
                <div class="col-12">
                    <p class="text-muted small">Următoarea raportare</p>
                </div>
            </div>
        </div>

    </div>
</div>


    <!-- Tabs Navigation -->
    <div class="default-tab">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#summary">
                    <i class="las la-file-alt me-2"></i> Sumar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#financials">
                    <i class="lar la-chart-bar me-2"></i> Evolutie financiara
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="indicators-tab" data-bs-toggle="tab" data-bs-target="#indicators" role="tab" >
                    <i class="la la-calculator me-2"></i> Indicatori financiari
                </a>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content mt-4">
        <div class="tab-pane fade show active" id="summary" role="tabpanel">
        <!-----------------------------------------------------Tab 1 sumar------------------------------------------------------------------------------>
            <div class="row">
                <!-- Left Column: Despre Companie -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100" id="card-title-2" style="--bs-card-bg: rgba(94, 62, 208, 0.3);">
                        <div class="card-header border-0 pb-0">
                            <h5 class="card-title text-white">Despre companie</h5>
                        </div>
                        <div class="card-body">
                            {% for paragraph in business_description.split('\n') %}
                            <p class="tight">{{ paragraph.strip() }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            
                <!-- Right Column: Evoluție preț acțiune -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100" id="card-title-2" style="--bs-card-bg: rgba(94, 62, 208, 0.3);">
                        <div class="card-header border-0 pb-0">
                            <h5 class="card-title text-white">Evoluție preț acțiune</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-3">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-light" onclick="loadStockChart('1d')">1 zi</button>
                                    <button class="btn btn-outline-light" onclick="loadStockChart('1mo')">1 luna</button>
                                    <button class="btn btn-outline-light" onclick="loadStockChart('1y')">1 an</button>
                                    <button class="btn btn-outline-light" onclick="loadStockChart('5y')">5 ani</button>
                                    <button class="btn btn-outline-light" onclick="loadStockChart('max')">max</button>
                                </div>
                            </div>                                
                            <div id="lightweight-stock-chart" style="height: 300;"></div>
                        </div>
                    </div>
                </div>
            </div>

           <!-- -----------------------------New Row: 3 Additional Cards -------------------------------------------------------------------->
            <div class="row">
                <!-- Card 1 -->
                <div class="col-md-4 mb-4">
                    <div class="card text-white" style="--bs-card-bg: rgba(94, 62, 208, 0.3); height: 500px;">
                        <div class="card-header" style="height: 50px;">
                            <h5 class="card-title mb-0">Venituri</h5>
                        </div>
                        <div class="d-flex justify-content-between align-items-center text-white text-center" style="height: 80px; gap: 16px; white-space: nowrap; overflow: hidden; width: calc(100% - 32px); margin: 0 16px;">
                            <div><h5 class="mb-0 fw-semibold" id="rev-latest">2,945 mnRON</h5></div>
                            <span class="text-white-150">|</span>
                            <div><h5 class="mb-0 fw-semibold" id="rev-change">+17.3% a/a</h5></div>
                            <span class="text-white-150">|</span>
                            <div><h5 class="mb-0 fw-semibold" id="rev-period">FY/2024</h5></div>
                        </div>
                        <div class="card-body p-2 d-flex justify-content-center align-items-center" style="height: 350px">
                            <div class="position-relative w-100 h-100" style="max-width: 100%; overflow: hidden;">
                              <canvas id="revenueChartCanvas" class="w-100 h-100" style="max-width: 100%; height: auto;"></canvas>
                            </div>
                          </div>
                    </div>
                </div>
           
                <!-- Card 2 -->
                <div class="col-md-4 mb-4">
                    <div class="card" style="--bs-card-bg: rgba(94, 62, 208, 0.3); height: 500px;">
                        <div class="card-header" style="height: 50px;">
                            <h5 class="card-title text-white">Venituri pe segmente</h5>
                        </div>
                        <div class="card-body p-2 d-flex justify-content-center align-items-center" style="height: 350px">
                            <div id="segmentRevenueChart" class="position-relative w-100 h-100" style="max-width: 100%; overflow: hidden;">
                              <canvas id="segmentRevenueChartCanvas" class="w-100 h-100" style="max-width: 100%; height: auto;"></canvas>
                              <div id="donutCenterLabel" class="position-absolute top-50 start-50 translate-middle text-white text-center fw-semibold" style="pointer-events: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Card 3 -->
                <div class="col-md-4 mb-4">
                    <div class="card" style="--bs-card-bg: rgba(94, 62, 208, 0.3); height: 500px;">
                        <div class="card-header" style="height: 50px;">
                            <h5 class="card-title text-white">Profit net</h5>
                        </div>
                        <div class="d-flex justify-content-between align-items-center text-white text-center" style="height: 80px; gap: 16px; white-space: nowrap; overflow: hidden; width: calc(100% - 32px); margin: 0 16px;">
                            <div><h5 class="mb-0 fw-semibold" id="rev-latest">90.1 mnRON</h5></div>
                            <span class="text-white-150">|</span>
                            <div><h5 class="mb-0 fw-semibold" id="rev-change">-7.0% a/a</h5></div>
                            <span class="text-white-150">|</span>
                            <div><h5 class="mb-0 fw-semibold" id="rev-period">FY/2024</h5></div>
                          </div>
                        <div class="card-body p-2 d-flex justify-content-center align-items-center" style="height: 350px">
                            <div id="ProfitmarginChart" class="position-relative w-100 h-100" style="max-width: 100%; overflow: hidden;">
                              <canvas id="profitabilityChartCanvas" class="w-100 h-100" style="max-width: 100%; height: auto;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!------------------------------------------------Tab 2 Evolutie financiara----------------------------------------------------------------------------------->
        <div id="financials" class="tab-pane fade" role="tabpanel">
            <!-- Sub-tabs for Financial Statements -->
            <ul class="nav nav-pills mb-3">
                <li class="nav-item">
                    <a class="nav-link active" id="pl-tab" data-bs-toggle="tab" href="#pl_statement" role="tab">Cont de profit și pierdere</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="bs-tab" data-bs-toggle="tab" href="#balance_sheet" role="tab">Bilanț contabil</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cf-tab" data-bs-toggle="tab" href="#cf_statement" role="tab">Fluxuri de numerar</a>
                </li>
            </ul>
                <!----------------------------------------------------Subtab 1 Contul de profit si pierdere------------------------------------------------------------------------------->
            <!-- Profit&Loss Statement -->
                <div class="tab-content">
                <div id="pl_statement" class="tab-pane fade show active" role="tabpanel">
                    <!-- Buttons for selecting financial view -->
                    <div class="container-fluid px-0">
                        <div class="row align-items-center mb-4">
                            <!-- Left Column: Description -->
                            <div class="col-md-6">
                                <p class="mb-0 fw-medium text-muted">Vizualizează mai jos evolutia Contului de Profit si Pierdere. Alege un mod de vizualizare.</p>
                            </div>                    
                            <!-- Right Column: Button Group -->
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group" aria-label="Financial View Selection">
                                    <button id="btn-pl-annual" type="button" class="btn btn-outline-secondary w-100 btn-sm">anual</button>
                                    <button id="btn-pl-quarterly" type="button" class="btn btn-outline-secondary w-100 btn-sm">trimestrial</button>
                                    <button id="btn-pl-quarterly-cml" type="button" class="btn btn-outline-secondary w-100 btn-sm">trimestrial cumulat</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% set statement = pl_statement %}
                    {% if statement and statement | length > 0 %}
                    <div class="card-body">
                        <div class="table-responsive custom-scroll-wrapper">
                            <div class="table-container">
                                <table class="financials-table table primary-table-bordered table-hover align-middle text-white freeze-column">
                                    <thead class="thead-info">
                                        <tr>
                                            <th class="text-start" scope="col">Metric</th>
                                            {% set all_periods = [] %}
                                            {% for r in statement %}
                                                {% for p in r["values"].keys() %}
                                                    {% if p not in all_periods %}
                                                        {% set _ = all_periods.append(p) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            {% set all_periods = all_periods|sort %}
                                            {% for p in all_periods %}
                                                <th class="text-end">{{ p }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in statement %}
                                        <tr>
                                            <td class="text-start">{{ row["metric_name"] }}</td>
                                            {% for p in all_periods %}
                                                <td class="text-end">{{ row["values"][p] if p in row["values"] else "-" }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <p>📊 Date financiare indisponibile.</p>
                    {% endif %}                    
                </div>
                <!----------------------------------------------------Subtab 2 Bilant Contabil------------------------------------------------------------------------------->
                <!-- Balance Sheet -->
                <div id="balance_sheet" class="tab-pane fade" role="tabpanel">
                    <!-- Buttons for selecting financial view -->
                    <div class="container-fluid px-0">
                        <div class="row align-items-center mb-4">
                            <!-- Left Column: Description -->
                            <div class="col-md-6">
                                <p class="mb-0 fw-medium text-muted">Vizualizează mai jos evolutia Bilantului Contabil. Alege un mod de vizualizare.</p>
                            </div>                    
                            <!-- Right Column: Button Group -->
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group" aria-label="Financial View Selection">
                                    <button id="btn-bs-annual" type="button" class="btn btn-outline-secondary w-100 btn-sm">anual</button>
                                    <button id="btn-bs-quarterly-cml" type="button" class="btn btn-outline-secondary w-100 btn-sm">trimestrial cumulat</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% set statement = bs_statement %}
                    {% if statement and statement | length > 0 %}
                    <div class="card-body">
                        <div class="table-responsive custom-scroll-wrapper">
                            <div class="table-container">
                                <table class="financials-table table primary-table-bordered table-hover align-middle text-white freeze-column">
                                    <thead class="thead-info">
                                        <tr>
                                            <th class="text-start" scope="col">Metric</th>
                                            {% set all_periods = [] %}
                                            {% for r in statement %}
                                                {% for p in r["values"].keys() %}
                                                    {% if p not in all_periods %}
                                                        {% set _ = all_periods.append(p) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            {% set all_periods = all_periods|sort %}
                                            {% for p in all_periods %}
                                                <th class="text-end">{{ p }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in statement %}
                                        <tr>
                                            <td class="text-start">{{ row["metric_name"] }}</td>
                                            {% for p in all_periods %}
                                                <td class="text-end">{{ row["values"][p] if p in row["values"] else "-" }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <p>📊 Date financiare indisponibile.</p>
                    {% endif %}
                    
                </div>
                <!----------------------------------------------------Subtab 3 Fluxuri de numerar------------------------------------------------------------------------------->
                <!-- CF Statement -->
                <div id="cf_statement" class="tab-pane fade" role="tabpanel">
                    <!-- Buttons for selecting financial view -->
                    <div class="container-fluid px-0">
                        <div class="row align-items-center mb-4">
                            <!-- Left Column: Description -->
                            <div class="col-md-6">
                                <p class="mb-0 fw-medium text-muted">Vizualizează mai jos evolutia Fluxurilor de Numerar. Alege un mod de vizualizare.</p>
                            </div>                    
                            <!-- Right Column: Button Group -->
                            <div class="col-md-6">
                                <div class="btn-group w-100" role="group" aria-label="Financial View Selection">
                                    <button id="btn-cf-annual" type="button" class="btn btn-outline-secondary w-100 btn-sm">anual</button>
                                    <button id="btn-cf-quarterly" type="button" class="btn btn-outline-secondary w-100 btn-sm">trimestrial</button>
                                    <button id="btn-cf-quarterly-cml" type="button" class="btn btn-outline-secondary w-100 btn-sm">trimestrial cumulat</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% set statement = cf_statement %}
                    {% if statement and statement | length > 0 %}
                    <div class="card-body">
                        <div class="table-responsive custom-scroll-wrapper">
                            <div class="table-container">
                                <table class="financials-table table primary-table-bordered table-hover align-middle text-white freeze-column">
                                    <thead class="thead-info">
                                        <tr>
                                            <th class="text-start" scope="col">Metric</th>
                                            {% set all_periods = [] %}
                                            {% for r in statement %}
                                                {% for p in r["values"].keys() %}
                                                    {% if p not in all_periods %}
                                                        {% set _ = all_periods.append(p) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            {% set all_periods = all_periods|sort %}
                                            {% for p in all_periods %}
                                                <th class="text-end">{{ p }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in statement %}
                                        <tr>
                                            <td class="text-start">{{ row["metric_name"] }}</td>
                                            {% for p in all_periods %}
                                                <td class="text-end">{{ row["values"][p] if p in row["values"] else "-" }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <p>📊 Date financiare indisponibile.</p>
                    {% endif %}

                </div>
            </div>
        </div>
        <!----------------------------------------------------Tab 3 Indicatori financiari------------------------------------------------------------------------------->
        <div id="indicators" class="tab-pane fade" role="tabpanel" aria-labelledby="indicators-tab">
            <div class="container-fluid px-0 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-0 fw-medium text-muted">Vizualizează mai jos principalii indicatori financiari. Alege un mod de vizualizare.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group w-100" role="group" aria-label="Ratios View Selection">
                            <button id="btn-ratios-annual" class="btn btn-outline-secondary btn-sm">anual</button>
                            <button id="btn-ratios-quarter" class="btn btn-outline-secondary btn-sm">trimestrial</button>
                            <button id="btn-ratios-quarter-cml" class="btn btn-outline-secondary btn-sm">trimestrial cumulat</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion accordion-active-header" id="accordion-ratios"></div>
        </div>
    </div>
</div>

<!-- Load Chart -->
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>

<script>
    function loadStockChart(period = '1y') {
        const ticker = "{{ ticker }}";
    
        fetch(`/historical_data/${ticker}/${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("lightweight-stock-chart").innerHTML = "<p>Date indisponibile.</p>";
                    return;
                }

                // Clear chart before redrawing
                document.getElementById("lightweight-stock-chart").innerHTML = "";

                const chart = LightweightCharts.createChart(document.getElementById('lightweight-stock-chart'), {
                    width: document.getElementById('lightweight-stock-chart').clientWidth,
                    height: 300,
                    layout: {
                        background: { color: 'transparent' },
                        textColor: '#ffffff',
                    },
                    grid: {
                        vertLines: { visible: false },
                        horzLines: { color: 'rgba(255,255,255,0.1)' },
                    },
                    timeScale: {
                        timeVisible: true,
                        borderColor: '#ffffff33',
                    },
                    rightPriceScale: {
                        borderColor: '#ffffff33',
                    },
                });
    
                const areaSeries = chart.addAreaSeries({
                    topColor: 'rgba(79, 209, 197, 0.5)',
                    bottomColor: 'rgba(79, 209, 197, 0)',
                    lineColor: '#4FD1C5',
                    lineWidth: 2,
                });
    
                const chartData = data.dates.map((date, i) => ({
                    time: date.split('T')[0],
                    value: parseFloat(data.prices[i])
                }));
                
                areaSeries.setData(chartData);
                chart.timeScale().fitContent();
    
                window.addEventListener('resize', () => {
                    chart.resize(document.getElementById('lightweight-stock-chart').clientWidth, 300);
                });
            })
            .catch(err => console.error("❌ Error loading chart", err));
    }

    // ✅ Load default chart on page load
    document.addEventListener("DOMContentLoaded", function () {
        loadStockChart('1y');
    });

// --- Financials Data Logic ---
function updateFinancialTable(tabId, data) {
    const container = document.querySelector(`#${tabId} .table-container`);
    if (!container) return console.error(`❌ Container not found for tabId: ${tabId}`);
    console.log("✅ Data from API:", data);
    if (!data || data.length === 0) {
        container.innerHTML = "<p>📊 Date financiare indisponibile.</p>";
        return;
    }
    let allPeriods = new Set();
    data.forEach(row => {
        Object.keys(row.values).forEach(date => allPeriods.add(date));
    });
    let sortedPeriods = Array.from(allPeriods).sort((a, b) => new Date(a) - new Date(b));
    let theadHTML = "<thead class='thead-info'><tr><th class='text-start'>Metric</th>";
    sortedPeriods.forEach(period => {
        theadHTML += `<th class="text-end">${period}</th>`;
    });
    theadHTML += "</tr></thead>";
    let tbodyHTML = "<tbody>";
    data.forEach(row => {
        tbodyHTML += `<tr><td class="text-start">${row.metric_name}</td>`;
        sortedPeriods.forEach(period => {
            tbodyHTML += `<td class="text-end">${row.values[period] || "-"}</td>`;
        });
        tbodyHTML += `</tr>`;
    });
    tbodyHTML += "</tbody>";
    container.innerHTML = `
        <table class="table primary-table-bordered table-hover align-middle text-white freeze-column">
            ${theadHTML}
            ${tbodyHTML}
        </table>
    `;
}

function loadFinancialData(tabID, periodType, aggrType) {
    const ticker = "{{ ticker }}";
    let endpoint;
    if (tabID === "pl_statement") endpoint = "pl_data";
    else if (tabID === "balance_sheet") endpoint = "bs_data";
    else if (tabID === "cf_statement") endpoint = "cf_data";
    else return console.error(`❌ Unknown tab ID: ${tabID}`);
    const url = `/${endpoint}/${ticker}/${periodType}/${aggrType}`;
    console.log("📡 Fetching URL:", url);
    fetch(url)
        .then(response => response.json())
        .then(data => updateFinancialTable(tabID, data))
        .catch(error => console.error("❌ Fetch error:", error));
}

// --- Ratios Data Logic ---
function loadRatiosData(periodType, aggrType) {
    const ticker = "{{ ticker }}";
    const url = `/ratios_data/${ticker}/${periodType}/${aggrType}`;
    console.log("📡 Fetching ratios from:", url);
    fetch(url)
        .then(response => response.json())
        .then(data => updateRatiosTable(data))
        .catch(err => console.error("❌ Error loading ratios", err));
}

function updateRatiosTable(data) {
    const container = document.getElementById("accordion-ratios");
    if (!container) {
        console.warn("⚠️ 'accordion-ratios' container not found in DOM.");
        return;
    }

    if (!data || Object.keys(data).length === 0) {
        container.innerHTML = "<p>📊 Nicio informație disponibilă.</p>";
        return;
    }

    // Clear previous content
    container.innerHTML = "";

    // Build dynamic accordion
    let index = 0;
    for (const [category, statement] of Object.entries(data)) {
        index++;
        const collapseId = `collapse_ratio_${index}`;
        const headerId = `accord_ratio_${index}`;

        let allPeriods = new Set();
        statement.forEach(r => {
            Object.keys(r.values).forEach(p => allPeriods.add(p));
        });
        let sortedPeriods = Array.from(allPeriods).sort((a, b) => new Date(a) - new Date(b));

        // Table headers
        let thead = `<thead><tr><th class='text-start'>Indicator</th>`;
        sortedPeriods.forEach(p => {
            thead += `<th class='text-end'>${p}</th>`;
        });
        thead += `</tr></thead>`;

        // Table body
        let tbody = `<tbody>`;
        statement.forEach(row => {
            tbody += `<tr><td class='text-start'>${row.metric_name}</td>`;
            sortedPeriods.forEach(p => {
                const value = p in row.values ? `${(parseFloat(row.values[p])).toFixed(2)}%` : 'n.a.';
                tbody += `<td class='text-end'>${value}</td>`;
            });
            tbody += `</tr>`;
        });
        tbody += `</tbody>`;

        // Accordion item
        container.innerHTML += `
            <div class="accordion-item">
                <div class="accordion-header rounded-lg"
                        id="${headerId}"
                        data-bs-toggle="collapse"
                        data-bs-target="#${collapseId}"
                        aria-expanded="true"
                        aria-controls="${collapseId}"
                        role ="button">
                    <span class="accordion-header-text">Accordion Header One</span>
                </div>

                <div id="${collapseId}" class="collapse accordion__body"
                    aria-labelledby="${headerId}"
                    data-bs-parent="#accordion-ratios">
                    <div class="table-responsive custom-scroll-wrapper text-white">
                            <div class="table-container">
                                <table class="table border-0 table-striped align-middle text-white freeze-column">
                                    ${thead}
                                    ${tbody}
                                </table> 
                            </div>
                    </div>
                </div>
            </div>
        `;
        
        }
    }

    // ✅ Rebind after accordion is built
    //bindAccordionToggleArrows();
    

function bindAccordionToggleArrows() {
    /*const headers = document.querySelectorAll('#accordion-ratios .accordion-button');

    headers.forEach(header => {
        const collapseId = header.getAttribute('data-bs-target');
        const arrow = header.querySelector('.accordion-arrow-icon');
        const target = document.querySelector(collapseId);

        if (!arrow || !target) return;

        target.addEventListener('shown.bs.collapse', () => {
            arrow.innerHTML = '&#x25B2;'; // ▲
        });

        target.addEventListener('hidden.bs.collapse', () => {
            arrow.innerHTML = '&#x25BC;'; // ▼
        });
    });*/
}

function cssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

const chartTheme = {
  // Original vibrant tones
  pink: {
    base: cssVar('--bs-pink'),           // #e83e8c
    hover: 'rgba(232, 62, 140, 0.7)',
    active: '#b52a6c'
  },
  red: {
    base: cssVar('--bs-red'),            // #EE3232
    hover: 'rgba(238, 50, 50, 0.7)',
    active: '#b92424'
  },
  orange: {
    base: cssVar('--bs-orange'),         // #ff9900
    hover: 'rgba(255, 153, 0, 0.7)',
    active: '#cc7a00'
  },
  yellow: {
    base: cssVar('--bs-yellow'),         // #FFFA6F
    hover: 'rgba(255, 250, 111, 0.7)',
    active: '#d4d058'
  },
  green: {
    base: cssVar('--bs-green'),          // #297F00
    hover: 'rgba(41, 127, 0, 0.7)',
    active: '#1b5500'
  },
  teal: {
    base: cssVar('--bs-teal'),           // #20c997
    hover: 'rgba(32, 201, 151, 0.7)',
    active: '#178c6b'
  },
  cyan: {
    base: cssVar('--bs-cyan'),           // #3065D0
    hover: 'rgba(48, 101, 208, 0.7)',
    active: '#254ba0'
  },
  primary: {
    base: cssVar('--bs-primary'),        // #53CAFD
    hover: 'rgba(83, 202, 253, 0.7)',
    active: '#027fb5'
  },
  secondary: {
    base: cssVar('--bs-secondary'),      // #E43BFF
    hover: 'rgba(228, 59, 255, 0.7)',
    active: '#9d2ea8'
  },
  success: {
    base: cssVar('--bs-success'),        // #1EAE7A
    hover: 'rgba(30, 174, 122, 0.7)',
    active: '#167d56'
  },
  info: {
    base: cssVar('--bs-info'),           // #00afef
    hover: 'rgba(0, 175, 239, 0.7)',
    active: '#0083b2'
  },
  warning: {
    base: cssVar('--bs-warning'),        // #FFAA2B
    hover: 'rgba(255, 170, 43, 0.7)',
    active: '#cc8421'
  },
  danger: {
    base: cssVar('--bs-danger'),         // #f72b50
    hover: 'rgba(247, 43, 80, 0.7)',
    active: '#a8203f'
  },
  blue: {
    base: cssVar('--bs-blue'),           // #391995
    hover: 'rgba(57, 25, 149, 0.7)',
    active: '#2c0d80'
  },
  indigo: {
    base: cssVar('--bs-indigo'),         // #6610f2
    hover: 'rgba(102, 16, 242, 0.7)',
    active: '#430bbb'
  },
  purple: {
    base: cssVar('--bs-purple'),         // #6f42c1
    hover: 'rgba(111, 66, 193, 0.7)',
    active: '#4f2e9b'
  }
}

Chart.register(ChartDataLabels);

function loadRevenueChart() {
    fetch('/revenue_data/{{ ticker }}')
        .then(response => {
            if (!response.ok) throw new Error("Backend returned an error");
            return response.json();
        })
        .then(data => {
            if (!data || !data.values?.length || !data.periods?.length) {
                console.warn("🚫 Incomplete revenue data");
                return;
            }

            const canvas = document.getElementById("revenueChartCanvas");
            if (!canvas) {
                console.error("❌ Canvas element not found");
                return;
            }

            const ctx = canvas.getContext("2d");
            const values = data.values.map(val => Number(val) / 1_000_000); // Convert to mn RON
            const labels = data.periods;
            const maxVal = Math.max(...values);

            const niceMax = Math.ceil(maxVal / 100) * 100;
            const step = Math.ceil(niceMax / 4);
            const roundedMax = step * 4;

            if (window.revenueChartInstance) {
                window.revenueChartInstance.destroy();
            }

            Chart.defaults.font.family = 'Poppins';

            window.revenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Venituri',
                        data: values,
                        backgroundColor: chartTheme.primary.base,
                        hoverBackgroundColor: chartTheme.primary.hover,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: roundedMax,
                            ticks: {
                                stepSize: step,
                                color: '#fff',
                                callback: value => `${value.toLocaleString("en-US", { maximumFractionDigits: 0 })} mn`
                            },
                            border: {
                                display: true,
                                color: 'rgba(255,255,255,0.3)',
                                width: 1
                            }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { drawOnChartArea: false, drawTicks: false },
                            border: {
                                display: true,
                                color: 'rgba(255,255,255,0.3)',
                                width: 1
                            }
                        }
                    },
                    plugins: {
                        datalabels: { display: false },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(240,240,240,0.2)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderWidth: 0,
                            titleFont: { weight: 'bold' },
                            bodyFont: { weight: 'bold' },
                            callbacks: {
                                label: function (ctx) {
                                    return `Venituri: ${ctx.raw.toLocaleString("en-US", { minimumFractionDigits: 1, maximumFractionDigits: 1 })} mnRON`;
                                }
                                }

                        }
                    }
                }
            });
        })
        .catch(err => {
            console.error("❌ Revenue chart load failed:", err);
        });
}

function loadSegmentRevenueChart() {
    fetch('/segment_revenue_data/{{ ticker }}')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            const chartContainer = document.getElementById("segmentRevenueChart");

            if (!data || !data.data || data.data.length === 0) {
                chartContainer.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-pie-chart-fill fs-3 text-white-50"></i>
                        <p class="text-white mt-2">Nicio structură de venit disponibilă.</p>
                    </div>`;
                return;
            }

            const segments = data.data;
            const period = data.period || "Perioadă necunoscută";
            const labels = segments.map(item => item.label);
            const values = segments.map(item => item.value);
            const total = values.reduce((a, b) => a + b, 0);

            // 🎨 Use 5 colors from chartTheme
            const backgroundColors = [
                chartTheme.orange.base,
                chartTheme.teal.base,
                chartTheme.cyan.base,
                chartTheme.pink.base,
                chartTheme.primary.base
            ];

            if (window.segmentRevenueChartInstance) {
                window.segmentRevenueChartInstance.destroy();
            }

            const ctx = document.getElementById("segmentRevenueChartCanvas").getContext("2d");

            window.segmentRevenueChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        offset: (ctx) => {
                            const label = ctx.chart.data.labels[ctx.dataIndex];
                            return ['Transport', 'Logistică'].includes(label) ? 40 : 0;
                        }
                    }]
                },
                options: {
                    rotation: 35,
                    cutout: '60%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 12,
                                    family: 'Poppins',
                                    weight: 'bold'
                                },
                                padding: 12,
                                boxWidth: 16
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                size: 14,
                                weight: 'bold',
                                lineHeight: 1.4
                            },
                            align: 'end',
                            anchor: 'end',
                            offset: 14,
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const pct = ((value / total) * 100).toFixed(1);
                                return `${pct}%`;
                            }
                        }
                    }
                }
            });

            const centerLabel = document.getElementById("donutCenterLabel");
            if (centerLabel) {
                centerLabel.textContent = period;
            }
        })
        .catch(err => {
            console.error("❌ Eroare la încărcarea veniturilor pe segmente:", err);
            document.getElementById("segmentRevenueChart").innerHTML =
                `<p class='text-white'>Eroare la încărcarea datelor.</p>`;
        });
}


function loadProfitabilityChart() {
    fetch('/profit_and_margin_data/{{ ticker }}')
        .then(response => {
            if (!response.ok) throw new Error("Backend returned an error");
            return response.json();
        })
        .then(data => {
            if (!data || !data.periods?.length || !data.profit?.length || !data.margin?.length) {
                console.warn("🚫 Incomplete data received");
                return;
            }

            const canvas = document.getElementById("profitabilityChartCanvas");
            if (!canvas) {
                console.error("❌ Canvas element not found");
                return;
            }

            const ctx = canvas.getContext("2d");
            const labels = data.periods;
            const profits = data.profit.map(v => v / 1_000_000);
            const margins = data.margin;
            const profitMax = Math.max(...profits);      
            const marginMax = Math.max(...margins); 

            function calculateProfitAxisScale(rawMax) {
                const niceMax = Math.ceil(rawMax / 100) * 100;
                const step = Math.ceil(niceMax / 4);
                const roundedMax = step * 4;
                
                return { roundedMax, step };
            }
                        function calculateMarginAxisScale(rawMax) {
                let roundTo;

                if (rawMax <= 5) roundTo = 1;
                else if (rawMax <= 20) roundTo = 2;
                else if (rawMax <= 50) roundTo = 5;
                else roundTo = 10;

                const niceMax = Math.ceil(rawMax / roundTo) * roundTo;
                const step = Math.ceil(niceMax / 4);
                const roundedMax = step * 4;

                return { roundedMax, step };
            }

            const { roundedMax: yMax, step: yStep } = calculateProfitAxisScale(profitMax);
            const { roundedMax: y1Max, step: y1Step } = calculateMarginAxisScale(marginMax);


            console.log("📊 Labels:", labels);
            console.log("📊 Profits:", profits);
            console.log("📊 Margins:", margins);

            if (window.profitabilityChartInstance) {
                window.profitabilityChartInstance.destroy();
            }
            Chart.defaults.font.family = 'Poppins';

            window.profitabilityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Profit net',
                            data: profits,
                            backgroundColor: chartTheme.secondary.base,
                            hoverBackgroundColor: chartTheme.secondary.hover,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order:2,
                            z:1
                        },
                        {
                            type: 'line',
                            label: 'Marjă netă',
                            data: margins,
                            order:1,
                            z:2,
                            borderColor: '#A9DDD6',
                            backgroundColor: '#A9DDD6',
                            hoverBackgroundColor: chartTheme.pink.hover,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            title: { display: false, text: 'Profit net (mnRON)' },
                            ticks: { color: '#fff', stepSize: yStep, callback: value => `${value.toFixed(0)} mn` },
                            
                            border: {display: true, color: 'rgba(255,255,255,0.3)', width: 1, z: 1}
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            max: y1Max,
                            title: { display: false, text: 'Marjă netă (%)' },
                            ticks: { color: '#fff', stepSize:y1Step, callback: value => `${value.toFixed(1)}%` },
                            grid: {drawOnChartArea: false, drawTicks: false},
                            border: {display: true, color: 'rgba(255,255,255,0.3)', width: 1, z: 1}                           
                        },
                        x: {
                            ticks: {color:'#fff'},
                            grid: {drawOnChartArea: false, drawTicks: false},
                            border: {display: true, color: 'rgba(255,255,255,0.3)', width: 1, z: 1}
                        }
                    },
                    plugins: {
                        datalabels: {display: false},
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'center',
                            labels: {
                                color: '#fff',
                                font: {size: 12, family: 'Poppins'},
                                padding: 10,
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(240,240,240,0.2)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderWidth:0,
                            titleFont: {weight: 'bold'},
                            bodyFont: {weight: 'bold'},
                            callbacks: {
                                label: function (ctx) {
                                    if (ctx.dataset.yAxisID === 'y') {
                                        return `Profit net: ${ctx.raw.toFixed(1)} mnRON`;
                                    } else {
                                        return `Marjă netă: ${ctx.raw.toFixed(2)}%`; 
                                    }
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {console.error("❌ Chart load failed:", err);});
}


// --- Setup Event Listeners ---
document.addEventListener("DOMContentLoaded", function () {
    // On page load, load default chart data
    loadStockChart('1y');

    // 🔥 Load revenue bar chart
    loadRevenueChart();

    // Load segment revenue pie chart
    loadSegmentRevenueChart();

    // Load profitability chart
    loadProfitabilityChart();

    // Financials sub-tab buttons (if you still want extra button functionality)
    document.getElementById("btn-pl-annual").addEventListener("click", () => {
        loadFinancialData("pl_statement", "annual", "cml");
    });
    document.getElementById("btn-pl-quarterly").addEventListener("click", () => {
        loadFinancialData("pl_statement", "quarter", "qtl");
    });
    document.getElementById("btn-pl-quarterly-cml").addEventListener("click", () => {
        loadFinancialData("pl_statement", "quarter", "cml");
    });
    document.getElementById("btn-bs-annual").addEventListener("click", () => {
        loadFinancialData("balance_sheet", "annual", "cml");
    });
    document.getElementById("btn-bs-quarterly-cml").addEventListener("click", () => {
        loadFinancialData("balance_sheet", "quarter", "cml");
    });
    document.getElementById("btn-cf-annual").addEventListener("click", () => {
        loadFinancialData("cf_statement", "annual", "cml");
    });
    document.getElementById("btn-cf-quarterly").addEventListener("click", () => {
        loadFinancialData("cf_statement", "quarter", "qtl");
    });
    document.getElementById("btn-cf-quarterly-cml").addEventListener("click", () => {
        loadFinancialData("cf_statement", "quarter", "cml");
    });
    
    // Ratios tab buttons
    document.getElementById("btn-ratios-annual").addEventListener("click", () => {
        loadRatiosData("annual", "cml");
    });
    document.getElementById("btn-ratios-quarter").addEventListener("click", () => {
        loadRatiosData("quarter", "qtl");
    });
    document.getElementById("btn-ratios-quarter-cml").addEventListener("click", () => {
        loadRatiosData("quarter", "cml");
    });
    
    // Listen for main tab changes (for example, when switching to "Evoluție financiara" or "Indicatori financiari")
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            const targetTabId = e.target.getAttribute("data-bs-target");
            if (targetTabId === "#financials") {
                // When Financials tab is shown, the default sub-tab is set via the Bootstrap markup (active on PL)
                // You can optionally trigger a load here if needed:
                loadFinancialData("pl_statement", "annual", "cml");
            }
            if (targetTabId === "#indicators") {
                loadRatiosData("annual", "cml");
            }
        });
    });
});

</script>

<script src="{{ url_for('static', filename='vendor/jquery-nice-select/js/jquery.nice-select.min.js') }}"></script> 
<script src="{{ url_for('static', filename='vendor/jquery-autocomplete/jquery-ui.js') }}"></script>

<script src="{{ url_for('static', filename='js/custom.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/dlabnav-init.js') }}"></script>
<!-- Custom Logic - LAST -->


<!-- DO NOT INCLUDE Bootstrap 5.3 JavaScript (Popper.js Included) -->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
<script src="{{ url_for('static', filename='js/highlight.min.js') }}"></script>
</body>
</html>

